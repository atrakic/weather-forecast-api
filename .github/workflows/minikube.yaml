# Demo how to use minikube as CI env with github Actions
#
# Usage:
# git checkout -b minikube
# git push

name: minikube
on:
  workflow_dispatch:
  push:
    branches:
      - 'minikube'
    paths-ignore:
      - '**/README.md'

env:
  IMAGE_NAME: local/example

jobs:
  minikube-ci:
    runs-on: ubuntu-latest
    name: build and deploy to minikube
    defaults:
      run:
        shell: bash
        working-directory: src

    steps:
      - uses: actions/checkout@v2
      - name: Start minikube
        uses: medyagh/setup-minikube@master

      - name: Try the cluster
        run: kubectl get all -A

      - name: Build local image
        run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env)
          docker build -f ./Dockerfile -t ${{ env.IMAGE_NAME }} .
          echo -n "verifying images:"
          docker image ls ${{ env.IMAGE_NAME }}

      - name: Deploy app to minikube
        run:
          kubectl apply -f ../deploy/minikube/manifest.yaml
          kubectl wait --for=condition=Ready pods --timeout=300s -l "app=weather-forecast-api"

      - name: Test service URLs
        run: |
          minikube service list
          minikube service example --url
          echo "------------------opening the service------------------"
          curl $(minikube service weather-forecast-api --url)
          eval $(minikube docker-env --unset)
          minikube delete
